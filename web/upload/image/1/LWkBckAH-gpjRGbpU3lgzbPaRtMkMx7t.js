"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var Ecg={devices:[],device_id:"",service_id:"",indicate_id:"",write_id:"",read_id:"",notify_id:"",start_command:"ff03100114",device_sn_command:"ff031a001d",device_sn_byte:{},connect_state:false,record_state:0,finish_state_count:0,record_id:0,record_delay_time:5000,record_time_long:30000,record_time_start:0,record_file_name:'',record_file_id:'',record_timer:null,evn:'test',wx:undefined,debug:false,fs:undefined,sdk_app_token:"",sdk_user_token:"",app_type:"XCX",app_version:"1.0",data_list:[],init:function init(evn,wx,sdk_app_token){var _this=this;_this.wx=wx;if(evn!='test'&&evn!='prepare'&&evn!='prod'){_this.show_modal('提示','evn环境只能为test（测试）、prepare（预发布）、prod（线上）',false);}else{_this.evn=evn;}
_this.fs=_this.wx.getFileSystemManager();_this.sdk_app_token=sdk_app_token;},set_debug:function set_debug(flag){this.debug=flag;},get_server_url:function get_server_url(){var _this=this;if(_this.evn=='prod'){return'https://ecg.mhealth365.cn/api';}else if(_this.evn=='prepare'){return'https://ecgtest.mhealth365.cn/api';}else{return'https://njtest.mhealth365.cn/api';}},compare_version:function compare_version(ver1,ver2){var version1pre=parseFloat(ver1);var version2pre=parseFloat(ver2);var version1next=parseInt(ver1.replace(version1pre+".",""));var version2next=parseInt(ver2.replace(version2pre+".",""));if(version1pre>version2pre)return true;else if(version1pre<version2pre)return false;else{if(version1next>version2next)return true;else return false;}},check_support:function check_support(app){var _this=this;if(app.getPlatform()=='android'&&_this.compare_version('6.5.7',app.getVersion())){_this.show_modal('提示','当前微信版本过低，请更新至最新版本',false);}else if(app.getPlatform()=='ios'&&_this.compare_version('6.5.6',app.getVersion())){_this.show_modal('提示','当前微信版本过低，请更新至最新版本',false);}},open_ble_adapter:function open_ble_adapter(_success,_fail){var _this=this;_this.wx.openBluetoothAdapter({success:function success(res){_this.log("open success",res);if(_this.is_function(_success)){_success(res);}},fail:function fail(res){_this.log("open fail",res);_this.show_modal('提示','请开启手机蓝牙后再试本',false);if(_this.is_function(_fail)){_fail(res);}}});},close_ble_adapter:function close_ble_adapter(){var _this=this;_this.wx.closeBluetoothAdapter({success:function success(res){_this.log("res"+res);_this.connect_state=false;_this.record_state=0;}});},start_ble_discovery:function start_ble_discovery(_success2,_fail2){var _this=this;_this.wx.startBluetoothDevicesDiscovery({success:function success(res){_this.log('search success',res);if(_this.is_function(_success2)){_success2(res);}},fail:function fail(res){_this.log('search fail',res);if(_this.is_function(_fail2)){_fail2(res);}}});},stop_ble_discovery:function stop_ble_discovery(){var _this=this;_this.wx.stopBluetoothDevicesDiscovery({success:function success(res){_this.log("res"+res);}});},get_service_id:function get_service_id(device_id){var _this=this;_this.wx.getBLEDeviceServices({deviceId:device_id,success:function success(res){var service_id="";for(var i=0;i<res.services.length;i++){_this.log(res.services[i].uuid);if(res.services[i].uuid.toUpperCase().indexOf("6E400001")!=-1){service_id=res.services[i].uuid;_this.setData({service_id:res.services[i].uuid});_this.get_characteristics_id('BLE');break;}else if(res.services[i].uuid.toUpperCase().indexOf("49535343")!=-1){service_id=res.services[i].uuid;_this.setData({service_id:res.services[i].uuid});_this.get_characteristics_id('BLE_OLD');break;}else if(res.services[i].uuid.toUpperCase().indexOf("E7810A71")!=-1){service_id=res.services[i].uuid;_this.setData({service_id:res.services[i].uuid});_this.get_characteristics_id('CLASSIC');break;}}
_this.log('fee7-service_id:',_this.service_id);},fail:function fail(res){_this.log(res);}});},get_characteristics_id:function get_characteristics_id(deviceType){var _this=this;_this.wx.getBLEDeviceCharacteristics({deviceId:_this.device_id,serviceId:_this.service_id,success:function success(res){_this.log('device特征值:',res.characteristics);if(deviceType=='BLE'){for(var i=0;i<res.characteristics.length;i++){var charc=res.characteristics[i];_this.log('charc:',charc);if(charc.properties.indicate){_this.setData({indicate_id:charc.uuid});_this.log('indicate_id:',_this.indicate_id);}
if(charc.properties.write){_this.setData({write_id:charc.uuid});_this.log('写write_id:',_this.write_id);}
if(charc.properties.read){_this.setData({read_id:charc.uuid});_this.log('读read_id:',_this.read_id);}
if(charc.properties.notify){_this.setData({notify_id:charc.uuid});_this.log('notify_id:',_this.notify_id);}}}else if(deviceType=='BLE_OLD'){for(var i=0;i<res.characteristics.length;i++){var charc=res.characteristics[i];_this.log('charc:',charc);if(charc.properties.indicate){_this.setData({indicate_id:charc.uuid});_this.log('indicate_id:',_this.indicate_id);}
if(charc.properties.write&&charc.uuid=='49535343-8841-43F4-A8D4-ECBE34729BB3'){_this.setData({write_id:charc.uuid});_this.log('写write_id:',_this.write_id);}
if(charc.properties.read){_this.setData({read_id:charc.uuid});_this.log('读read_id:',_this.read_id);}
if(charc.properties.notify&&charc.uuid=='49535343-1E4D-4BD9-BA61-23C647249616'){_this.setData({notify_id:charc.uuid});_this.log('notify_id:',_this.notify_id);}}}else if(deviceType=='CLASSIC'){for(var i=0;i<res.characteristics.length;i++){var charc=res.characteristics[i];_this.log('charc:',charc);if(charc.properties.indicate){_this.setData({indicate_id:charc.uuid});_this.log('indicate_id:',_this.indicate_id);}
if(charc.properties.write){_this.setData({write_id:charc.uuid});_this.log('写write_id:',_this.write_id);}
if(charc.properties.read){_this.setData({read_id:charc.uuid});_this.log('读read_id:',_this.read_id);}
if(charc.properties.notify){_this.setData({notify_id:charc.uuid});_this.log('notify_id:',_this.notify_id);}}}}});},setData:function setData(obj){var _this=this;for(var i in obj){_this[i]=obj[i];}},open_notification:function open_notification(_success3,_fail3){var _this=this;_this.log('开启notify');_this.wx.notifyBLECharacteristicValueChange({state:true,deviceId:_this.device_id,serviceId:_this.service_id,characteristicId:_this.notify_id,success:function success(res){_this.log('开启notify:'+res.errMsg);if(_this.is_function(_success3)){_success3(res);}},fail:function fail(res){_this.log('开启notify:'+res.errMsg);if(_this.is_function(_fail3)){_fail3(res);}}});},read:function read(callback){var _this=this;_this.wx.onBLECharacteristicValueChange(function(res){_this.log(res.value);var hex=_this.ab2hext(res.value);_this.log(hex);_this.log('特征值变化');if(_this.is_function(callback)){callback(hex);}});},create_record_file:function create_record_file(data,_success4,_fail4){var _this=this;_this.record_file_id=_this.uuid();_this.record_file_name=_this.wx.env.USER_DATA_PATH+"/"+_this.record_file_id+".txt";_this.fs.writeFile({filePath:_this.record_file_name,data:data,encoding:"utf8",fail:function fail(res){_this.log("write fail",res);if(_this.is_function(_fail4)){_fail4(res);}},success:function success(res){_this.log("write success",res);if(_this.is_function(_success4)){_success4(res);}}});},append_record_file:function append_record_file(data,_success5,_fail5){var _this=this;_this.fs.appendFile({filePath:_this.record_file_name,data:data,encoding:"utf8",fail:function fail(res){_this.log("write fail",res);if(_this.is_function(_fail5)){_fail5(res);}},success:function success(res){_this.log("write success",res);if(_this.is_function(_success5)){_success5(res);}}});},send:function send(data,_success6,_fail6){var _this=this;var buffer=_this.hexStringToArrayBuffer(data);_this.wx.writeBLECharacteristicValue({deviceId:_this.device_id,serviceId:_this.service_id,characteristicId:_this.write_id,value:buffer,success:function success(res){_this.log('发送数据:',res);if(_this.is_function(_success6)){_success6(res);}},fail:function fail(res){_this.record_state=0;_this.log(res);if(_this.is_function(_fail6)){_fail6(res);}}});},hexStringToArrayBuffer:function hexStringToArrayBuffer(str){if(!str){return new ArrayBuffer(0);}
var buffer=new ArrayBuffer(str.length/2);var dataView=new DataView(buffer);var ind=0;for(var i=0,len=str.length;i<len;i+=2){var code=parseInt(str.substr(i,2),16);dataView.setUint8(ind,code);ind++;}
return buffer;},ab2hext:function ab2hext(buffer){var hexArr=Array.prototype.map.call(new Uint8Array(buffer),function(bit){return('00'+bit.toString(16)).slice(-2);});return hexArr.join('');},show_modal:function show_modal(title,content,show_cancel){var _this=this;_this.wx.showModal({title:title,content:content,showCancel:show_cancel});},auth:function auth(obj,wx){var _this=this;_this.http_req("/sdk2/sdk/auth",{app_id:obj.client_id,app_secret:obj.client_secret,app_package_name:obj.app_package_name},{app_type:_this.app_type,app_version:_this.app_version},function(res){if(_this.is_success(res)){_this.setData({'sdk_app_token':res.data.sdk_app_token});if(_this.is_function(obj.success)){obj.success(res);}}else{if(_this.is_function(obj.fail)){obj.fail(res);}}},function(){},wx);},login:function login(obj){var _this=this;_this.http_req("/sdk2/user/login",{user_name:obj.user_name,password:obj.password,openid:obj.openid},{sdk_app_token:_this.sdk_app_token,app_type:_this.app_type,app_version:_this.app_version},function(res){if(_this.is_success(res)){_this.setData({'sdk_user_token':res.data.sdk_user_token});if(_this.is_function(obj.success)){obj.success(res);}}else{if(_this.is_function(obj.fail)){obj.fail(res);}}});},auto_login:function auto_login(obj){var _this=this;_this.http_req("/sdk2/user/check-login",{openid:obj.openid},{sdk_app_token:_this.sdk_app_token,app_type:_this.app_type,app_version:_this.app_version},function(res){if(_this.is_success(res)){_this.setData({'sdk_user_token':res.data.sdk_user_token});if(_this.is_function(obj.success)){obj.success(res);}}else{if(_this.is_function(obj.fail)){obj.fail(res);}}});},register:function register(obj){var _this=this;_this.http_req("/sdk2/user/register",{user_name:obj.user_name,password:obj.password,sex:obj.sex,age:obj.age,phone:obj.phone,email:obj.email,openid:obj.openid},{sdk_app_token:_this.sdk_app_token,app_type:_this.app_type,app_version:_this.app_version},function(res){if(_this.is_success(res)){if(_this.is_function(obj.success)){obj.success(res);}}else{if(_this.is_function(obj.fail)){obj.fail(res);}}},function(res){if(_this.is_function(obj.fail)){obj.success(res);}});},search_ble:function search_ble(obj){var _this=this;_this.open_ble_adapter(function(){_this.start_ble_discovery(function(){_this.devices=[];_this.wx.onBluetoothDeviceFound(function(devices){_this.log('发现设备:',devices.devices);for(var i=0;i<devices.devices.length;i++){var device=devices.devices[i];_this.log(device);_this.log(_this.devices);if(device.name.indexOf('mHealth365')>-1){var dev={id:device.deviceId,name:device.name};_this.devices.push(dev);if(_this.is_function(obj.listen)){obj.listen(dev);}}}});},function(res){if(_this.is_function(obj.fail)){obj.fail(res);}});},function(res){if(_this.is_function(obj.fail)){obj.fail(res);}});},connect_ble:function connect_ble(obj){var _this=this;_this.open_ble_adapter(function(res){_this.wx.createBLEConnection({deviceId:obj.device_id,timeout:obj.timeout,success:function success(res){_this.log("success connect "+res);_this.device_id=obj.device_id;_this.get_service_id(obj.device_id);_this.connect_state=true;_this.stop_ble_discovery();if(_this.is_function(obj.success)){obj.success(res);}
_this.on_ble_connect_change(obj);},fail:function fail(res){_this.log("fail connect "+res.errCode+res.errMsg);_this.close_ble_adapter();_this.connect_state=false;_this.record_state=0;if(_this.is_function(obj.fail)){obj.fail(res);}},complete:function complete(res){_this.log("connect ble complete");if(_this.is_function(obj.complete)){obj.complete(res);}}});},function(res){if(_this.is_function(obj.fail)){obj.fail(res);}});},get_connected_bles:function get_connected_bles(obj){var _this=this;if(_this.service_id==""){if(_this.is_function(obj.success)){return obj.success([]);}}
_this.wx.getConnectedBluetoothDevices({services:[_this.service_id],success:function success(res){if(_this.is_function(obj.success)){var connected_bles=[];var len=res.devices.length;if(len>0){for(var i=0;i<len;i++){connected_bles.push({id:res.devices[i].deviceId,name:res.devices[i].name});}}
obj.success(connected_bles);}},fail:function fail(res){if(_this.is_function(obj.fail)){obj.fail(res);}}});},on_ble_connect_change:function on_ble_connect_change(obj){var _this=this;_this.wx.onBLEConnectionStateChange(function(res){if(!res.connected){_this.connect_state=false;}
if(_this.is_function(obj.change)){obj.change(res);}});},start_record:function start_record(obj){var _this=this;_this.data_list=[];_this.finish_state_count=0;_this.on_ble_connect_change(obj);_this.open_notification(function(res){_this.read(function(data){if(data=="ff120f30003000300030003000300030003000a1"&&_this.is_function(obj.drop)&&_this.record_state==2){obj.drop(data);}
if(_this.record_state==1){_this.data_list.push(data);}else if(_this.record_state==2){_this.data_list.push(data);}else if(_this.record_state==3){if(data.indexOf('ff0303')>-1||_this.finish_state_count==50){console.log(data);console.log(_this.finish_state_count);_this.record_state=0;var dataList=_this.data_list.join("|");_this.create_record_file(dataList,function(res){_this.upload_record({openid:obj.openid,success:function success(res2){if(_this.is_success(res2)){_this.record_id=res2.data.record_id;if(_this.is_function(obj.finish)){obj.finish(res2);}}else{if(_this.is_function(obj.fail)){obj.fail(res2);}}
_this.data_list=[];dataList="";},fail:function fail(res2){if(_this.is_function(obj.fail)){obj.fail(res2);}}});},function(res){obj.fail(res);});}else{_this.finish_state_count++;_this.data_list.push(data);}}});_this.send(_this.device_sn_command,function(res){_this.record_state=1;_this.send(_this.start_command,function(res){if(_this.is_function(obj.success)){obj.success(res);}
_this.record_state=2;_this.record_time_start=new Date().getTime();_this.record_timer=setTimeout(function(){_this.record_state=3;},_this.record_time_long);},function(res){_this.record_state=0;if(_this.is_function(obj.fail)){obj.fail(res);}});},function(res){_this.record_state=0;if(_this.is_function(obj.fail)){obj.fail(res);}});},function(res){if(_this.is_function(obj.fail)){obj.fail(res);}});},stop_record:function stop_record(obj){var _this=this;_this.log(_this.record_state);if(_this.record_state!=1){if(_this.is_function(obj.fail)){obj.fail({errCode:95003,errMsg:'记录尚未开始'});}
return;}
_this.record_state=3;if(_this.is_function(obj.success)){obj.success({errCode:0,errMsg:'正常'});}},discard_record:function discard_record(obj){var _this=this;clearTimeout(_this.record_timer);_this.log(_this.record_state);_this.record_state=0;_this.data_list=[];if(_this.is_function(obj.success)){obj.success({errCode:0,errMsg:'正常'});}},upload_record:function upload_record(obj){var _this=this;return _this.http_upload_req("/sdk2/record/upload-record",_this.record_file_name,{'file_id':_this.record_file_id,'record_time_start':_this.record_time_start/1000,'record_time_long':_this.record_time_long/1000,'openid':obj.openid},{'sdk_app_token':_this.sdk_app_token,'sdk_user_token':_this.sdk_user_token,app_type:_this.app_type,app_version:_this.app_version},function(data){if(_this.is_function(obj.success)){obj.success(data);}},function(data){if(_this.is_function(obj.fail)){obj.fail(data);}});},get_record_info:function get_record_info(obj){var _this=this;return _this.http_req("/sdk2/record/get-record-info",{'record_id':obj.record_id},{'sdk_app_token':_this.sdk_app_token,'sdk_user_token':_this.sdk_user_token,app_type:_this.app_type,app_version:_this.app_version},function(data){if(_this.is_success(data)){if(_this.is_function(obj.success)){obj.success(data);}}else{if(_this.is_function(obj.fail)){obj.fail(data);}}},function(data){if(_this.is_function(obj.fail)){obj.fail(data);}});},get_record_list:function get_record_list(obj){var _this=this;return _this.http_req("/sdk2/record/get-record-list",{max:obj.max,page:obj.page},{'sdk_app_token':_this.sdk_app_token,'sdk_user_token':_this.sdk_user_token,app_type:_this.app_type,app_version:_this.app_version},function(data){if(_this.is_success(data)){if(_this.is_function(obj.success)){obj.success(data);}}else{if(_this.is_function(obj.fail)){obj.fail(data);}}},function(data){if(_this.is_function(obj.fail)){obj.fail(data);}});},get_anonymous_record_list:function get_anonymous_record_list(obj){var _this=this;return _this.http_req("/sdk2/record/get-anonymous-record-list",{openid:obj.openid,max:obj.max,page:obj.page},{'sdk_app_token':_this.sdk_app_token},function(data){if(_this.is_success(data)){if(_this.is_function(obj.success)){obj.success(data);}}else{if(_this.is_function(obj.fail)){obj.fail(data);}}},function(data){if(_this.is_function(obj.fail)){obj.fail(data);}});},send_record_to_hotline:function send_record_to_hotline(obj){var _this=this;return _this.http_req("/sdk2/record/send-record-to-hotline",{'record_id':obj.record_id,'notify_url':obj.notify_url},{'sdk_app_token':_this.sdk_app_token,'sdk_user_token':_this.sdk_user_token,app_type:_this.app_type,app_version:_this.app_version},function(data){if(_this.is_success(data)){if(_this.is_function(obj.success)){obj.success(data);}}else{if(_this.is_function(obj.fail)){obj.fail(data);}}},function(data){if(_this.is_function(obj.fail)){obj.fail(data);}});},is_success:function is_success(res){return res.errCode==0;},is_function:function is_function(o){return this.is(o,'function');},is:function is(o,type){var isnan={"NaN":1,"Infinity":1,"-Infinity":1};type=type.toLowerCase();if(type=="finite"){return!isnan["hasOwnProperty"](+o);}
if(type=="array"){return o instanceof Array;}
return type=="null"&&o===null||type==(typeof o==="undefined"?"undefined":_typeof(o))&&o!==null||type=="object"&&o===Object(o)||type=="array"&&Array.isArray&&Array.isArray(o)||Object.prototype.toString.call(o).slice(8,-1).toLowerCase()==type;},log:function log(){var _this=this;if(_this.debug){console.log(arguments);}},http_req:function http_req(method,data,header,_success7,_fail7,wx){var _this=this;var url=_this.get_server_url()+method;if(header!=undefined){header['content-type']='application/x-www-form-urlencoded';}else{header={'content-type':'application/x-www-form-urlencoded'};}
var nwx=_this.wx;if(nwx==undefined&&wx!=undefined){nwx=wx;}
nwx.request({url:url,data:data,header:header,method:'POST',dataType:'json',success:function success(res){if(_this.is_function(_success7)){_success7(res.data);}},fail:function fail(res){_this.log(data);if(_this.is_function(_fail7)){_fail7(res.data);}}});},http_upload_req:function http_upload_req(method,filePath,data,header,_success8,_fail8){var _this=this;var url=_this.get_server_url()+method;if(header!=undefined){header['content-type']='multipart/form-data';}else{header={'content-type':'multipart/form-data'};}
_this.wx.uploadFile({url:url,filePath:filePath,name:'fname',formData:data,header:header,success:function success(res){if(_this.is_function(_success8)){_success8(JSON.parse(res.data));}},fail:function fail(res){_this.log(data);if(_this.is_function(_fail8)){_fail8(JSON.parse(res.data));}}});},uuid:function uuid(){var s=[];var hexDigits="0123456789abcdef";for(var i=0;i<36;i++){s[i]=hexDigits.substr(Math.floor(Math.random()*0x10),1);}
s[14]="4";s[19]=hexDigits.substr(s[19]&0x3|0x8,1);s[8]=s[13]=s[18]=s[23]="-";var uuid=s.join("");return uuid;}};module.exports=Ecg;